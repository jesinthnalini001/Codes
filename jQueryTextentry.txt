Qualtrics.SurveyEngine.addOnload(function() {

    var maxCharacters = 300; // update as needed, 0 = no limit
    var q = jQuery("#"+this.questionId); 
    var input = q.find(".InputText"); 
    input.after("<div style='font-size: 0.8em; float: right;'>Characters remaining: <span class='charRemaining'></span><span class='maxCharacters'></span></div>"); 
    var charRemainingDisplay = q.find(".charRemaining");
    
    if (maxCharacters > 0) {
        q.find('.maxCharacters').text("/" + maxCharacters);
    }

    countCharacters(input.get(0)); 
    input.on("input", function() { countCharacters(this) }); 
    input.blur(function() { this.value = this.value.trim(); });

    function countCharacters(el) {
        var charCount = el.value.length;

        if (maxCharacters > 0) {
            var remainingChars = maxCharacters - charCount;
            charRemainingDisplay.text(remainingChars >= 0 ? remainingChars : 0);
            if (charCount > maxCharacters) {
                el.value = el.value.slice(0, maxCharacters);
            }
        } else {
            charRemainingDisplay.text(charCount);
        }
    }
});
